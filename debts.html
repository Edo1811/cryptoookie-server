<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>$Cryptoookie Debts</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <h1>Outstanding Debts</h1>
  <p>Each decayed cookie costs 10% of its current value per hour. Repay to stop interest temporarily ‚Äî or sell the cookie entirely once fully cleared.</p>

  <div class="wallet">
    Current Balance: $<span id="balance">0.00</span>
  </div>

  <table id="debtsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Cookie Type</th>
        <th>Amount</th>
        <th>Current Value</th>
        <th>Accrued Debt</th>
        <th>Status</th>
        <th colspan="2">Actions</th>
      </tr>
    </thead>
    <tbody id="debtsBody"></tbody>
  </table>

  <p style="margin-top:20px;">
    <a href="exchange.html" class="btn">‚¨Ö Back to Exchange</a>
  </p>

  <script>
    <script>
  // === Server and Session Setup ===
  const SERVER = "https://5938507d-829f-4f48-a35a-529eba66f3f1-00-1fgovj5vv1hca.riker.replit.dev";

  const username = sessionStorage.getItem("username");
  if (!username) window.location.href = "login.html";

  let playerData = JSON.parse(sessionStorage.getItem("playerData"));
  let debts = playerData.debts || [];
  let balance = playerData.balance || 0;

  const debtsBody = document.getElementById("debtsBody");
  const balanceEl = document.getElementById("balance");

  // === Sync player data to backend ===
  async function savePlayerData() {
    const player = { ...playerData, balance, debts };
    await fetch(`${SERVER}/api/save`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, player }),
    });
    sessionStorage.setItem("playerData", JSON.stringify(player));
  }

  // === Render table ===
  function updateBalance() {
    balanceEl.textContent = balance.toFixed(2);
  }

  function renderDebts() {
    debtsBody.innerHTML = "";
    if (debts.length === 0) {
      const row = document.createElement("tr");
      row.innerHTML = `<td colspan="8">‚úÖ No decayed cookies at the moment.</td>`;
      debtsBody.appendChild(row);
      updateBalance();
      return;
    }

    debts.forEach((d, i) => {
      const status = d.sold ? "‚úÖ Sold" : (d.accruedDebt > 0 ? "üíÄ Owing" : "‚è≥ Idle");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${i + 1}</td>
        <td>${d.type}</td>
        <td>${d.amount}</td>
        <td>$${d.currentValue.toFixed(2)}</td>
        <td>$${d.accruedDebt.toFixed(2)}</td>
        <td>${status}</td>
        <td>
          <button class="btn" onclick="repayDebt(${i})" ${d.sold ? "disabled" : ""}>Repay</button>
        </td>
        <td>
          <button class="btn" onclick="sellCookie(${i})" ${d.accruedDebt > 0 || d.sold ? "disabled" : ""}>Sell</button>
        </td>
      `;
      debtsBody.appendChild(row);
    });
    updateBalance();
  }

  // === Repay + Sell ===
  function repayDebt(i) {
    const d = debts[i];
    if (d.sold) return;
    if (balance < d.accruedDebt) return alert("Not enough balance to repay this debt!");
    balance -= d.accruedDebt;
    d.accruedDebt = 0;
    savePlayerData();
    alert(`You repaid debt #${i + 1}.`);
    renderDebts();
  }

  function sellCookie(i) {
    const d = debts[i];
    if (d.accruedDebt > 0) return alert("You must repay all debt before selling!");
    balance += d.currentValue * d.amount;
    d.sold = true;
    savePlayerData();
    alert(`Sold ${d.amount}x ${d.type} for $${(d.currentValue * d.amount).toFixed(2)}.`);
    renderDebts();
  }

  // === Debt growth (10% per hour scaled for demo) ===
  setInterval(() => {
    debts.forEach(d => {
      if (!d.sold) {
        const increase = (d.currentValue * 0.1) / 360;
        d.accruedDebt += increase;
      }
    });
    renderDebts();
    savePlayerData();
  }, 10000);

  renderDebts();
</script>

  </script>

</body>
</html>
